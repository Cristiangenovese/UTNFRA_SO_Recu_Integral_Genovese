#!/bin/bash
clear

echo ">>> Ejecutando configuración del Punto C..."

# ===== Variables =============================================
DOCKER_USER="cgenovese"                       # ← tu usuario de Docker Hub
IMAGE_NAME="web3_ri2024-genovese"            # nombre de la imagen (todo minúsculas)
TAG="latest"
PROJECT_DIR="$HOME/202408/docker"            # carpeta base del punto C
WEB_DIR="$PROJECT_DIR/web"
FILE_DIR="$WEB_DIR/file"
INDEX_HTML="$WEB_DIR/index.html"
DOCKERFILE="$PROJECT_DIR/Dockerfile"
COMPOSE_FILE="$PROJECT_DIR/docker-compose.yml"
INFO_FILE="$FILE_DIR/info.txt"

# ===== Preparar estructura ===================================
echo ">>> Creando estructura de carpetas…"
mkdir -p "$FILE_DIR"

# ===== index.html ============================================
echo ">>> Generando index.html…"
cat <<'EOF' > "$INDEX_HTML"
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Recuperatorio Integral 2024</title>
</head>
<body>
  <ul>
	<li>Nombre: Cristian Genovese<li>
	<li>Division:318<li>
  <ul>
</body>
</html>
EOF

# ===== Dockerfile ============================================
echo ">>> Generando Dockerfile…"
cat <<'EOF' > "$DOCKERFILE"
FROM nginx:alpine
COPY web /usr/share/nginx/html
EOF

# ===== info.txt ==============================================
echo ">>> Generando info.txt…"
CPU_MODEL=$(grep -m1 'model name' /proc/cpuinfo | cut -d: -f2 | xargs)
CPU_FREQ=$(awk -F: '/cpu MHz/{printf "%.2fGHz", $2/1000; exit}' /proc/cpuinfo)
echo "CPU Modelo: $CPU_MODEL Frecuencia: $CPU_FREQ" > "$INFO_FILE"

# ===== Build & Push ==========================================
cd "$PROJECT_DIR"
echo ">>> Construyendo imagen Docker…"
docker build -t "$DOCKER_USER/$IMAGE_NAME:$TAG" . || {
  echo " Error al construir la imagen"; exit 1; }

echo ">>> Pusheando imagen a Docker Hub…"
docker push "$DOCKER_USER/$IMAGE_NAME:$TAG" || {
  echo "X Error al pushear la imagen"; exit 1; }

# ===== docker-compose.yml ====================================
echo ">>> Generando docker-compose.yml…"
cat <<EOF > "$COMPOSE_FILE"
version: '3.8'
services:
  web:
    image: $DOCKER_USER/$IMAGE_NAME:$TAG
    ports:
      - '8081:80'
    volumes:
      - ./web/file:/usr/share/nginx/html/file
EOF

# ===== Levantar servicio =====================================
echo ">>> Levantando contenedor con Docker Compose…"
docker compose -f "$COMPOSE_FILE" up -d

echo "\n>>> ✅ Punto C completado con éxito. Accedé a http://localhost:8081 para ver la página."

